---
name: Security - CVE-2025-64439

on:
  push:
    branches: [main]
  pull_request:

jobs:
  check-langgraph-checkpoint:
    name: Check langgraph-checkpoint >= 3.0.0
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install packaging

      - name: Check pyproject.toml for vulnerable versions
        run: |
          echo "Checking for CVE-2025-64439 (langgraph-checkpoint RCE vulnerability)..."

          # Check if any pyproject.toml files have langgraph-checkpoint < 3.0.0
          if grep -r "langgraph-checkpoint.*<.*3\.0\.0" . --include="pyproject.toml"; then
            echo "❌ ERROR: Found pyproject.toml with langgraph-checkpoint < 3.0.0"
            echo "This version is vulnerable to CVE-2025-64439 (Remote Code Execution)"
            exit 1
          fi

          # Check if langgraph-checkpoint is pinned to a safe version
          if grep -r "langgraph-checkpoint" . --include="pyproject.toml"; then
            echo "✓ Found langgraph-checkpoint in dependencies"

            # Verify it requires >= 3.0.0
            if ! grep -r "langgraph-checkpoint.*>=.*3\.0\.0\|langgraph-checkpoint.*>=3\|langgraph-checkpoint.*==.*3\." . --include="pyproject.toml"; then
              echo "⚠️  WARNING: langgraph-checkpoint version constraint may be too loose"
              echo "Please ensure it's pinned to >= 3.0.0"
              exit 1
            fi
          fi

          echo "✓ All langgraph-checkpoint versions are safe (>= 3.0.0)"

      - name: Verify runtime guard exists
        run: |
          echo "Checking for runtime version guards..."

          # Check if runtime guards are present in checkpoint implementations
          for init_file in $(find libs -name "__init__.py" -path "*/langgraph*checkpoint*/__init__.py"); do
            if grep -q "CVE-2025-64439" "$init_file"; then
              echo "✓ Runtime guard found in $init_file"
            else
              echo "⚠️  No runtime guard found in $init_file"
              echo "Consider adding version check for CVE-2025-64439"
            fi
          done

      - name: Block JSON mode usage (optional)
        continue-on-error: true
        run: |
          echo "Checking for unsafe JSON mode usage..."

          # Check for explicit JSON mode usage (should be avoided)
          if grep -r "enable_json_mode.*=.*True\|\"json\".*mode" libs --include="*.py" | grep -v "test" | grep -v "#"; then
            echo "⚠️  WARNING: Found potential JSON mode usage"
            echo "JSON mode is vulnerable in langgraph-checkpoint < 3.0.0"
            echo "Ensure you're using msgpack mode only"
          else
            echo "✓ No explicit JSON mode usage detected"
          fi

      - name: Security summary
        run: |
          echo "================================================"
          echo "CVE-2025-64439 Security Check Complete"
          echo "================================================"
          echo "✓ langgraph-checkpoint >= 3.0.0 requirement verified"
          echo "✓ No vulnerable versions detected"
          echo ""
          echo "For more information:"
          echo "  - CVE: https://nvd.nist.gov/vuln/detail/CVE-2025-64439"
          echo "  - Advisory: GHSA-wwqv-p2pp-99h5"
